# XiaoFaSSH 部署指南（Linux）

- 环境要求：
  - Python 3.8+
  - pip / venv（推荐使用虚拟环境）
- 安装依赖（中国镜像）：
  - `python3 -m venv .venv && . .venv/bin/activate`
  - `pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`
- 启动与端口：
  - 开发测试：`wssh --address=0.0.0.0 --port=8888`
  - 自定义端口：`wssh --address=0.0.0.0 --port=$PORT`
- 生产部署（示例 systemd）：
  - `/etc/systemd/system/xiaofa-ssh.service` 内容：
    ```
    [Unit]
    Description=XiaoFaSSH
    After=network.target

    [Service]
    WorkingDirectory=/opt/xiaofassh
    ExecStart=/opt/xiaofassh/.venv/bin/wssh --address=0.0.0.0 --port=8888
    Restart=always
    Environment=PYTHONUNBUFFERED=1

    [Install]
    WantedBy=multi-user.target
    ```
  - 运行：`sudo systemctl daemon-reload && sudo systemctl enable --now xiaofa-ssh`

- 端口与防火墙：
  - 开放对应端口（示例 8888），按云厂商/iptables/firewalld 规则自行放行。

- 依赖下载说明：
  - 默认使用中国镜像；如网络需要翻墙，请自行配置代理后再安装。

- 授权与开源声明：
  - 本项目基于 `https://github.com/huashengdun/webssh` 的 MIT 协议进行二次开发。
  - 除基础部分外，项目新增的 AI 智能体相关前端脚本（如 `static/js/main.js` 的 AI 逻辑）采用 Polyform Noncommercial License 1.0.0 授权：允许自用与非商业用途；商业使用需联系作者获取授权。
  - 如需商业授权，请联系：`yanghaopor`，邮箱:yanghao17308444882@gmail.com。

- 常见问题：
  - 启动卡住或无响应：可在页面点击“刷新SSH”按钮强制重连。
  - 视频背景加载失败：浏览器策略或网络原因，不影响功能；可刷新或改用静态图。
 
  - # XiaoFaSSH 使用说明与组件详解

XiaoFaSSH 是基于 WebSSH（MIT 协议）二次开发的 Web 终端，面向开发、运维与自动化场景，提供：
- 纯浏览器 SSH 连接与交互
- 深色终端主题与现代化 UI
- 顶部“组件毛玻璃”与底部“整块毛玻璃覆盖”视觉
- AI 智能体辅助（通过指令前缀触发），任务队列与记忆管理
- 文件上传、记忆导入导出、任务管理等扩展功能

本文详细说明如何使用它、能做什么、适用场景、注意事项，以及界面各组件的功能说明。

---

## 1. 能做什么
- 在浏览器中安全地连接到远程 Linux/Unix 服务器并执行命令
- 通过顶部输入框与 AI 协作：构造命令、批量任务排程、记录/导出记忆
- 上传本地文件到远端目录、查看任务/日志/JSON 原文
- 在页面卡死或网络波动时，一键刷新 SSH 连接

## 2. 适用场景
- 远程运维：快速登录、执行诊断、查看日志
- 自动化任务：通过 AI 辅助生成命令与串行队列执行
- 轻量工具平台：在企业或个人站点嵌入 Web 终端能力
- 教学/演示：无需安装桌面客户端，浏览器直接操作

## 3. 快速开始
- Windows（推荐 PowerShell，依赖请使用中国镜像）：
  - 创建虚拟环境：`py -m venv .venv`，激活：`.\.venv\Scripts\activate`
  - 安装依赖：`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`
  - 启动服务：`wssh --address=0.0.0.0 --port=8888`
- Linux：
  - `python3 -m venv .venv && . .venv/bin/activate`
  - `pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`
  - `wssh --address=0.0.0.0 --port=8888`
- 端口与防火墙：开放服务端口（默认 8888），并在云厂商/iptables/firewalld 放行

## 4. 页面结构与组件
- 顶部品牌区（`XiaoFaSSH`）
  - 白底不透明标题与副标题，统一黑色文本
- 登录表单（不透明，便于阅读）
  - `Hostname`、`Port`、`Username`、`Password`、`Private Key`（隐藏默认“选择文件”按钮，点击输入框即可选择）
  - `Passphrase`、`Totp`、`term`（默认 `xterm-256color`）
  - 连接与重置按钮（无背景、无边框、黑色文字）
- 终端区域（SSH）
  - 深色主题：背景 `#0f1115`、文字白色；支持选择高亮
  - 全屏模式背景统一深色
- 主面板（分割线上方的组件毛玻璃）
  - AI 配置窗口：
    - AI 提供商、模型编号、密钥、API 地址、规则提示词、禁止语法
    - “连通测试”按钮
  - 输入栏（命令/AI 专用输入）
    - 文本框为毛玻璃透明，黑色文字与占位符
    - 发送按钮（无背景边框）、刷新 SSH 按钮（无背景边框）
- 分割线（视觉分隔）
- 底部区域（分割线以下为整块毛玻璃覆盖层）
  - 信息区：命令状态、AI 状态、最近命令、性能指标（延迟/耗时/行数）
  - 命令输出区：最近输出回显（不透明白底，便于阅读）
  - JSON 原文：显示结构化数据或返回体原文
  - AI 日志：AI 执行过程中记录的日志
  - 记忆窗口：导出/导入/刷新（文件输入按钮隐藏，点击输入框选择）
  - 安全控制：如“清空任务记忆”等
  - 文件上传：远端目录、获取当前目录、选择文件、指定远端文件名、上传
  - 多任务：新增任务、查看队列与执行情况
  - 页面右下角水印：“YangHaoPor开发”

## 5. 操作流程（典型）
1) 填写连接信息并连接 SSH
2) 在终端运行命令或通过顶部输入栏发送命令
3) 使用“刷新SSH”处理偶发卡死
4) 需要 AI 辅助时：
   - 在输入框前加前缀触发 AI 模式（示例：`--AI! ls -la /var/log`）
   - 或使用“AI 专用输入”框由系统自动发送
5) 查看底部信息区与输出、AI 日志、JSON 原文等
6) 上传文件或管理任务/记忆

## 6. AI 与任务队列
- 触发方式：
  - 在用户输入前添加前缀：`--AI!`（或 `--!AI:` 的兼容形式）
  - 走主输入流程，系统序列化执行（`ExecScheduler`）
- 执行约束：
  - 仅在 AI 状态为“无任务/完成”时执行
  - 倒计时结束后才触发；最小时隔（示例）180 秒（可按实现调整）
  - 次数耗尽将自动移出任务栏
- 记录与日志：
  - AI 日志窗口显示过程信息，JSON 原文用于调试数据

## 7. 记忆管理
- 隔离策略：每个页面会话独立（`sessionStorage`），不同用户/标签页不互通
- 导出：生成 JSON 文件（含任务/监督角色的短/中/长三档）
- 导入：选择 JSON 文件后应用到当前会话
- 刷新：重新渲染记忆盒内容

## 8. 文件上传
- 指定远端目录（可留空使用家目录）
- 选择本地文件（点击输入框即可选择）
- 可选指定远端文件名（默认同名）
- 点击“上传”后通过 SSH 会话发送文件

## 9. 注意事项
- 安全：
  - 密钥/密文仅用于连接交互；请勿将敏感信息暴露在页面或日志中
  - 建议启用服务器侧的密钥登录与双因子（`Totp`）
- 网络：
  - 若依赖安装需要翻墙，请自行配置代理；默认使用中国镜像
- 兼容：
  - 背景视频可能因浏览器策略阻止自动播放；不影响功能
- 主题：
  - 顶部组件毛玻璃（透明），底部为整块毛玻璃覆盖层，组件保持不透明以提升可读性

## 10. 常见问题（FAQ）
- 连接失败
  - 检查 `Hostname/Port`、防火墙、SSH 服务状态
  - 若页面无响应，点击“刷新SSH”
- 视频背景加载失败
  - 与网络/浏览器策略相关；可使用 `poster` 或替换为静态图
- AI 指令未执行
  - 确认 AI 状态为“无任务/完成”，并等待倒计时结束

## 11. 许可与授权
- 基础项目：基于 `https://github.com/huashengdun/webssh` 的 MIT 协议开发
- AI 智能体前端脚本与相关扩展：Polyform Noncommercial License 1.0.0
  - 允许自用与非商业用途；商业使用需获得作者授权
  - 商用授权联系：`yanghaopor`

---

如需二次定制（主题、布局、AI 行为、任务调度策略等），可在 `static/css/theme.css` 与 `static/js/main.js` 中按模块化方式调整。

---

## 12. Agent 实现原理与层次职责

XiaoFaSSH 的前端 Agent 把“用户输入 → AI/命令执行 → 状态与记忆 → UI 呈现”串成一个可控的流水线，重点是让普通输入与 AI 任务在同一主通道顺序执行，避免竞态与打断。

- 输入层（主输入通道）
  - 角色：统一处理用户输入与 AI 任务输入，走相同发送逻辑
  - 关键点：`--AI!` 前缀触发 AI 模式，仍然通过主输入框与“发送”流程
  - 代码参考：`d:\CorsorPorjerct\WEBssh\.webssh-venv\Lib\site-packages\webssh\static\js\main.js:1619`

- 调度层（串行执行）
  - 角色：串行队列，保证同一时刻只有一个执行单元在跑
  - 机制：`enqueue → tick → done → 下一个`，当 AI 正在运行则不触发下一个
  - 代码参考：`main.js:2099` 的 `ExecScheduler`

- 状态层（AI 状态机与页面状态）
  - 角色：标记 AI 的运行态/结束态/异常态，用于判断何时允许新任务
  - 判定：仅在“AI: 完成/无任务”时允许继续
  - 代码参考：
    - `main.js:1367` 重载 `window.wssh_set_ai_task_state`
    - `main.js:2115` `aiReady()` 检查允许态

- 任务层（队列与倒计时）
  - 角色：维护任务的次数/间隔/计时；到点后把任务写入主输入框并发送
  - 机制：倒计时到零后执行；最小间隔（示例 180s）；次数用尽自动删除
  - 代码参考：
    - `main.js:2116` `createPipeline()` 负责把任务写入输入框并触发发送
    - `main.js:2185-2187` 倒计时与缓冲、下一次触发设定
    - `main.js:2211` `TaskManager.updateCountdowns()` 定时刷新倒计时显示

- 终端层（xterm.js）
  - 角色：负责 SSH 内容渲染与交互；深色主题与光标
  - 代码参考：`main.js:1158-1166` 终端主题（背景/前景/光标）

- 记忆层（会话隔离）
  - 角色：每页会话独立的短/中/长记忆，支持导出/导入
  - 数据：`sessionStorage`，按 `task/super` 与 `short/mid/long` 分类存储
  - 代码参考：
    - `main.js:238` `memSnapshot()` 生成导出快照
    - `main.js:2110-2117` `TaskManager` 中记忆读写（`mg/ms/mr/mp`）

---

## 13. 基础记忆原理（短/中/长）

- 记忆分层：
  - 短（short）：即时上下文碎片，容量小、易替换，用于临时提示与当前任务要点
  - 中（mid）：阶段性目标与中期总结，用于跨几次命令的连贯性
  - 长（long）：跨会话或长期策略/偏好/约束，用于稳定风格与通用规则
- 角色区分：
  - `task`：面向任务执行，记录任务链条提示与上下文
  - `super`：面向监督与策略，记录宏观约束与风格
- 存储与隔离：
  - 使用 `sessionStorage` 保证“每页面会话隔离”，不同用户/标签页互不影响
- 导出/导入：
  - 导出为 JSON（含版本、时间戳、各角色的短/中/长）
  - 导入时覆盖当前会话，立即生效并刷新显示

---

## 14. Token 预算与预估（简/复杂任务）

为便于控制开销与稳定性，建议在使用 AI 功能时按下述维度进行 Token 预算。以下为经验值，具体取决于使用的模型与上下文大小（常见上下文：8k、32k、128k、200k）。

- 构成维度：
  - 指令与系统提示：`300–1,000 tokens`
  - 记忆（短/中/长）：`500–3,000 tokens`（按启用层级而定）
  - 现场上下文（终端输出/日志/JSON 片段）：`800–5,000 tokens`
  - 代码/命令片段：`500–3,000 tokens`
  - 模型回复：`500–2,500 tokens`

- 简单任务（单条命令、少量上下文）
  - 输入侧：`2,000–4,000 tokens`
  - 回复侧：`500–1,000 tokens`
  - 总计：`2,500–5,000 tokens`

- 中等任务（多步命令、需要总结或少量文件片段）
  - 输入侧：`3,500–7,000 tokens`
  - 回复侧：`1,000–2,000 tokens`
  - 总计：`4,500–9,000 tokens`

- 复杂任务（长上下文、跨多次交互、较多记忆/日志）
  - 输入侧：`6,000–15,000 tokens`
  - 回复侧：`1,500–4,000 tokens`
  - 总计：`7,500–19,000 tokens`

- 控制建议：
  - 减少长记忆参与：仅在需要时加载 `long`，常态以 `short/mid` 为主
  - 精简现场上下文：对终端输出进行摘要，避免整段喂给模型
  - 限制回复长度：给模型明确字数/段落要求，降低回复 Token
  - 分批对话：把复杂任务分解为多轮，降低单次上下文压力

---

## 15. 设计选择与权衡

- 为确保稳定串行，AI 与手动命令共用主输入通道与调度器
- 页面记忆会话隔离，避免跨用户/跨页污染
- 底部区域采用整块毛玻璃覆盖层，组件保持不透明，提升可读性
- 顶部区域采用组件毛玻璃，保持轻盈现代的视觉
